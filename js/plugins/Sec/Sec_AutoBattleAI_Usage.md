# ⚔️ Sec_AutoBattleAI 智能战斗 AI (v4.0 终极战术版) 使用手册

## 1. 插件简介
**Sec_AutoBattleAI** 是专为 `Sec_BattleSystemInstance.js` 战斗体系打造的顶级战术 AI。
与传统 RPG Maker 的随机出招不同，v4.0 版本引入了 **“全维度伤害模拟” (Total Damage Simulation)** 引擎。AI 在行动前会模拟计算全场收益——不仅看单体伤害，还会计算**溅射**、**队友协战**、**状态引爆**以及**斩杀收益**，真正做到“像老玩家一样思考”。

---

## 2. 核心战术逻辑 (v4.0)

### 2.1 全维度伤害计算 (Total Damage Calculation)
AI 抛弃了死板的权重评分，转而计算技能的**期望总伤害**。
> **总评分 = 基础伤害 + 机制额外伤害 + AOE溅射总伤 + 队友协战期望伤**

* **基础伤害**：结合属性克制、防御减免后的预估数值。
* **机制伤害**：解析斩杀追击、蓄力释放、状态交互带来的额外伤害公式。
* **AOE 模拟**：遍历所有敌人，模拟溅射/弹射的覆盖范围，计算打谁能溅射到最多人。
* **协战模拟**：预判该技能是否会触发队友的 `<队友协战>`，将队友的输出也算作当前决策的收益。

### 2.2 蓄力闭环 (Charge Loop)
* **防内鬼保护**：当 AI 身上已有 `<受击蓄力>` 状态时，它会**严禁**使用任何可能刷新/覆盖该状态的技能，防止清空蓄力池。
* **智能释放**：只有当蓄力池有伤害 (`_secStoredDmg > 0`) 且预估释放伤害能造成有效打击（甚至斩杀）时，才会优先使用 `<蓄力释放>` 技能。

### 2.3 状态运营 (Cycle vs Interact)
AI 能理解“养猪”策略：
* **叠层阶段 (Cycle)**：检测到 `<状态循环>` 且目标状态未满层时，AI 认为“还没熟”，优先叠层。
* **收割阶段 (Interact)**：当状态已满层，或计算出 `<状态交互>` 的引爆伤害足以**直接斩杀**敌人时，AI 才会选择引爆。

### 2.4 力场共鸣 (Spread vs Gather)
* **扩散 (Spread)**：当场上感染该状态的敌人较少时，AI 判定为“播种期”，优先扩散。
* **聚焦 (Gather)**：当场上大部分敌人都已感染时，AI 判定为“收割期”，优先聚焦爆发。

### 2.5 守护光环 (Guardian Aura)
* **自动开关**：AI 自动读取角色/装备上的 `<守护光环>` 标签。
    * **未开启时**：开启光环的技能优先级极高 (+3000)。
    * **已开启时**：严禁重复释放同类技能 (-5000)，杜绝浪费回合。

---

## 3. 标签配置指南 (Note Tags)

请将以下标签填入 **技能 (Skill)**、**角色 (Actor)** 或 **状态 (State)** 的备注栏中。AI 会自动识别并生效。

### A. 技能标签 (Skill Note)

#### ⚔️ 输出与机制类
| 标签格式 | 作用说明 | AI 行为逻辑 |
| :--- | :--- | :--- |
| `<斩杀追击: 30, Formula>` | 敌人HP<30%触发额外伤 | **斩杀逻辑**：若计算出 (基础伤+Formula) ≥ 敌人当前HP，**绝对优先**使用 (权重 +10000)。 |
| `<蓄力释放: StateID, Formula>` | 释放蓄力池造成伤害 | **释放逻辑**：仅在有蓄力伤害时使用。会代入蓄力值 `d` 计算 Formula。 |
| `<受击蓄力: StateID>` | 获得蓄力状态 | **保护逻辑**：若自身已有该 StateID，本技能权重 **-5000** (禁用)。 |
| `<状态交互: StateID, Formula>` | 引爆状态造成伤害 | **Combo逻辑**：若敌人有该状态，计算 Formula 收益。优先用于斩杀。 |
| `<力场共鸣: StateID, Mode, ...>` | Spread(扩散)/Gather(聚焦) | **战术逻辑**：感染人数少时优先 Spread；人数多时优先 Gather。 |
| `<状态循环: ID1, ID2, ID3>` | 状态升级/循环 | **运营逻辑**：若敌人处于 ID1/ID2，优先叠层；若处于 ID3 (满层)，停止叠层，转为寻找引爆技能。 |
| `<溅射伤害: Rate, Range>` | 对周围造成溅射 | **AOE逻辑**：模拟计算所有被溅射目标的总伤害，以此选择最佳主目标。 |
| `<弹射伤害: ...>` | 在敌人间弹射 | **AOE逻辑**：视为强力群伤技能，给予额外权重。 |
| `<技能吸血: Rate>` | 造成伤害并回血 | **救命逻辑**：自身 HP < 50% 时，权重提升。 |
| `<推条: Val>` / `<拉条: Val>` | 改变行动条 | **控制逻辑**：视为战术控制技能，常驻高权重。 |

#### 🤖 AI 干预类 (手动控制)
如果您想强制改变 AI 对某个技能的看法，可添加以下标签：

| 标签格式 | 说明 |
| :--- | :--- |
| `<AI_Priority: 数值>` | 直接增加该技能的基础评分。例如 `<AI_Priority: 5000>` 让它几乎必放。 |
| `<AI_Type: Heal>` | 强制视为**治疗技能** (遵循救死扶伤逻辑)。 |
| `<AI_Type: Support>` | 强制视为**辅助技能** (首回合优先释放)。 |
| `<AI_Type: Push>` | 强制视为**推条技能**。 |
| `<AI_Type: Pull>` | 强制视为**拉条技能**。 |

### B. 角色/装备标签 (Actor/Equip Note)

| 标签格式 | 说明 |
| :--- | :--- |
| `<守护光环: StateID>` | 声明该角色依赖此状态作为光环。AI 会确保该状态常驻且不重复释放。 |
| `<队友协战: Type, Chance, SkillID>` | 声明该角色会协战。AI 队友在决策时会把这份协战伤害算进自己的收益里。 |

---

## 4. 插件参数详解

在插件管理器中配置 `Sec_AutoBattleAI`，可调整 AI 的“性格”。

### 阈值设置
* **HpCrisis (紧急治疗线)**: 默认 `40`。队友血量低于 40% 时，AI 会放弃输出全力奶人。
* **HpHeal (普通治疗线)**: 默认 `70`。队友血量低于 70% 时，AI 开始考虑使用低耗治疗。

### 权重设置 (Core Weights)
这些数值决定了 AI 在面临抉择时的倾向性。

| 参数名 | 默认值 | 含义 |
| :--- | :--- | :--- |
| **WeightHealCrisis** | 10000 | **救命权重**。建议设为最高，保证 AI 不会见死不救。 |
| **WeightControl** | 3000 | **控制权重**。推拉条技能的优先级。 |
| **WeightGuardian** | 3000 | **光环权重**。开启守护状态的优先级。 |
| **WeightCycle** | 2500 | **叠层权重**。优先叠状态而非过早引爆。 |
| **WeightSpread** | 2000 | **扩散权重**。力场共鸣中“Spread”模式的战术加分。 |
| **WeightCombo** | 2000 | **交互权重**。引爆状态的基础加分。 |
| **WeightAOE** | 800 | **群伤权重**。AOE 技能的基础加分（还会叠加实际模拟出的伤害分）。 |

---

## 5. 常见问题 (FAQ)

**Q: 为什么 AI 不使用我的强力技能？**
A: 请检查：
1.  MP/TP 是否足够？
2.  是否带有 `<受击蓄力>` 标签且自身已有该状态？（AI 会为了保护蓄力而禁用它）
3.  该技能的伤害公式是否过于复杂（例如用了自定义函数）？AI 使用模拟计算，如果公式中包含特殊脚本可能导致估算值为 0。建议手动添加 `<AI_Priority: 2000>` 修正。

**Q: AI 为什么对着满血敌人放斩杀技能？**
A: 可能是该技能基础伤害极高，或者计算出的总伤（含机制伤害）直接触发了斩杀线判定。也可能是您设置了过高的 `<AI_Priority>`。

**Q: 溅射技能为什么有时不打中间的怪？**
A: AI 会计算实际总伤。如果打边缘的怪能触发斩杀（比如那个怪残血），AI 可能会优先选择斩杀收益，而不是溅射收益。

**Q: 插件顺序有要求吗？**
A: 必须放在 `Sec_BattleSystemInstance.js` 和 `Sec_BattleLogPopup.js` **之后**。