# Sec_BattleSystemInstance.js 使用说明文档

## 1. 插件简介

### 1.1 基本信息
- **插件名称**: 战斗系统实例插件 - 正则兼容与功能修复版
- **目标引擎**: RPG Maker MZ
- **当前版本**: 2.9.6
- **作者**: Secmon (Refactored by Gemini)
- **功能**: 允许在角色、职业、装备、敌人或技能的备注栏中填写特定标签，实现丰富的战斗机制

### 1.2 插件特点
- **[New] 全面支持装备标签：穿戴特定武器/防具即可获得被动或协战能力**
- 模块化设计，功能清晰
- 支持多种战斗机制
- 提供丰富的实战案例
- 易于扩展和自定义
- 支持中文标点和英文标点
- 支持标签中的空格
- 增强的正则表达式匹配
- 修复了溅射伤害的触发问题
- 补全了协战/识破监听模块

## 2. 安装说明

### 2.1 安装步骤
1. 将 `Sec_BattleSystemInstance.js` 文件放入项目的 `js/plugins/Sec/` 目录中
2. 在 RPG Maker MZ 编辑器中打开插件管理界面
3. 点击「插件管理」按钮
4. 点击「添加」按钮，选择该插件
5. 调整插件优先级（建议放在其他战斗相关插件之后）
6. 点击「确定」保存设置

### 2.2 配置要求
- RPG Maker MZ 1.9.1 或更高版本
- 支持 JavaScript 语法

## 3. 通用变量表

在所有公式中，您可以使用以下变量：

| 变量名 | 说明 |
|--------|------|
| `a`    | 动作使用者 (或 亡语中的死者 / 转移中的守护者) |
| `b`    | 动作目标   (或 亡语中的凶手 / 转移中的被守护者) |
| `v[n]` | 游戏变量（例如 `v[10]` 表示第10个变量） |
| `s[n]` | 游戏开关（例如 `s[5]` 表示第5个开关） |
| `dmg`  | 本次行动造成的实际伤害数值（仅受击/吸血等逻辑可用） |
| `d`    | 原始伤害值（仅在特定机制中可用） |
| `n`    | 队友数量或弹射次数（仅在特定机制中可用） |
| `damage` | 上一次造成的伤害值（仅在弹射伤害中可用） |

## 4. 功能模块说明


### 4.1 模块 A：被动触发 (Passives)

**位置**：
- 角色 (Actor) 备注
- 职业 (Class) 备注
- **武器/防具 (Weapon/Armor) 备注**
- 敌人 (Enemy) 备注

*说明：系统会自动读取角色身上所有的备注信息（职业+装备+本体），只要其中一处有标签即可生效。*

#### 4.1.1 普攻特效

**填写位置**: 数据库 -> 职业 (Classes) -> 备注

**格式**: `<战斗触发:Attack, 公式>`

**参数说明**:
- `Attack`: 发起普攻时触发（仅对角色有效）
- `公式`: 任意有效的 JavaScript 代码

**示例**:
<战斗触发:Attack, a.gainMp(10)> //普攻时触发，为攻击者恢复10点MP

#### 4.1.2 受击特效

**填写位置**: 数据库 -> 职业 (Classes) -> 备注

**格式**: `<战斗触发:Hit, 公式>`

**参数说明**:
- `Hit`: 受到伤害时触发（仅对角色有效）
- `公式`: 任意有效的 JavaScript 代码

**示例**:
<战斗触发:Hit, a.gainTp(5)> //受击时触发，为受击者恢复5点TP

#### 4.1.3 亡语机制

**填写位置**: 数据库 -> 敌人 (Enemies) -> 备注

**格式**: `<战斗触发:Dead, 公式>`

**参数说明**:
- `Dead`: 角色死亡时触发
- `公式`: 任意有效的 JavaScript 代码
- `a`: 代表死者
- `b`: 代表造成最后一击的凶手

**示例**:
<战斗触发:Dead, b.gainHp(-1000); b.startDamagePopup()> //死亡时触发，对造成最后一击的敌人造成1000点伤害

### 4.2 技能主动模块

#### 4.2.1 溅射伤害

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<溅射伤害: 比例/公式, 范围>`

**参数说明**:
- `比例/公式`: 可以是 0.0-1.0 之间的小数（代表溅射伤害的比例），也可以是 JavaScript 计算公式
- `范围`: 整数，代表溅射伤害的范围（主目标左右各几个单位）

**示例**:
<溅射伤害: 0.5, 1> //对主目标左右各1个单位造成50%溅射伤害
<溅射伤害: (a.atk/1000), 2> //对主目标左右各2个单位造成基于攻击力的溅射伤害，公式结果会作为比例系数

#### 4.2.2 斩杀追击

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<斩杀追击: 阈值%, 公式>`

**参数说明**:
- `阈值%`: 1-100 之间的整数，代表目标血量的百分比
- `公式`: 任意有效的 JavaScript 代码，代表斩杀追击时的伤害值

**示例**:
<斩杀追击: 30, 2000> //若目标血量低于30%，追加2000点真实伤害

#### 4.2.3 技能吸血

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<技能吸血: 比例>`

**参数说明**:
- `比例`: 0.0-1.0 之间的小数，代表技能吸血的比例

**示例**:
<技能吸血: 0.3> //回复伤害值30%的血量

#### 4.2.4 状态交互

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<状态交互: 状态ID, 公式, 移除?, 范围>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `公式`: 任意有效的 JavaScript 代码，正数伤，负数奶
- `移除?`: `true` 或 `false`，代表是否移除状态
- `范围`: `Target`（仅对目标生效）、`Self`（仅对自己生效）、`AllAllies`（对所有队友生效）

**示例**:
<状态交互: 15, a.mat * 3, true, Target> //若目标有状态15，造成3倍魔攻伤害并移除状态

#### 4.2.5 力场共鸣

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<力场共鸣: 状态ID, 模式, 公式, 移除?>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `模式`: `Spread`（炸全场）、`Gather`（聚合并炸单体）
- `公式`: 任意有效的 JavaScript 代码，正数伤，负数奶
- `移除?`: `true` 或 `false`，代表是否移除状态

**示例**:
<力场共鸣: 50, Spread, a.mat * 2, true> //引爆全场带有状态50的单位，造成魔攻2倍伤害并移除状态

### 4.3 高级机制模块

#### 4.3.1 伤害转移

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<伤害转移: 状态ID, 分摊比例%, 转移公式, 恢复公式>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `分摊比例%`: 0.0-100.0 之间的小数，代表伤害转移的比例
- `转移公式`: 任意有效的 JavaScript 代码，代表伤害转移时的伤害值
- `恢复公式`: 任意有效的 JavaScript 代码，代表被守护者要回多少血

**示例**:
<伤害转移: 100, 100, d * 0.5, d> //队友受到的伤害100%被拦截，骑士只受50%伤害，队友完全不扣血

#### 4.3.2 累计反击

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<累计反击: 状态ID, 属性, 值, 反击公式>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `属性`: 开启期间提升的属性，如 "def"、"atk"、"mat" 等
- `值`: 属性提升的数值
- `反击公式`: 释放时的伤害公式

**示例**:
<累计反击: 110, def, 200, d * 3> //开启姿态时防御力+200，再次释放造成累计伤害3倍的反击伤害

#### 4.3.3 弹射伤害

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<弹射伤害: 初始公式, 弹射公式, 次数, 倍率上限, 允许重复?, 模式>`

**参数说明**:
- `初始公式`: 对第一个目标的伤害
- `弹射公式`: 对后续目标的伤害
- `次数`: 额外弹射几次
- `倍率上限`: 0 表示无限制，>0 表示公式中的 n 最大只能取到这个值
- `允许重复?`: `true` 或 `false`，代表是否可以打同一个人
- `模式`: `Random`（随机选择下一个）、`Order`（按敌人站位顺序）

**示例**:
<弹射伤害: 3000, damage * 0.8, 3, 0, false, Random> //首发3000伤害，弹射3次，每次伤害衰减20%，随机目标

### 4.4 全局行动监听模块

**位置**：
- 角色 (Actor) 备注
- 职业 (Class) 备注
- **武器/防具 (Weapon/Armor) 备注**
- 敌人 (Enemy) 备注

#### 4.4.1 队友协战

**填写位置**: 数据库 -> 职业 (Classes) 或 敌人 (Enemies) -> 备注

**格式**: `<队友协战: 触发类型, 概率%, 技能ID>`

**参数说明**:
- `触发类型`: `Attack`（普攻）、`Skill`（技能）、`Support`（支援）、`Any`（任意）
  - 除 `Any` 类型外，其他类型均不包含防御动作
- `概率%`: 0-100 之间的整数，代表触发协战的概率
- `技能ID`: 整数，代表协战时使用的技能ID

**功能特点**:
- **强制插队**: 使用 `this.forceAction(observer)` 确保协战立刻执行

**示例**:
<队友协战: Attack, 30, 10> //当队友进行普攻时，30%概率使用技能10进行协战

#### 4.4.2 敌方识破

**填写位置**: 数据库 -> 职业 (Classes) 或 敌人 (Enemies) -> 备注

**格式**: `<敌方识破: 触发类型, 概率%, 技能ID>`

**参数说明**:
- `触发类型`: `Support`（支援）、`Attack`（攻击）、`Any`（任意）
  - 排除防御：玩家防御不会误触发 Attack/Support 类型的识破
- `概率%`: 0-100 之间的整数，代表触发识破的概率
- `技能ID`: 整数，代表识破时使用的技能ID

**功能特点**:
- **强制插队**: 使用 `this.forceAction(observer)` 确保敌人立刻反击
- **目标智能锁定**:
  - 如果敌人反击用的是攻击技能，会精准锁定触发者（玩家）
  - 如果敌人反击用的是 Buff/回血技能，会锁定自己

**示例**:
<敌方识破: Support, 100, 30> //当敌人使用支援技能时，100%概率使用技能30进行识破

## 5. 使用示例

### 5.1 被动触发模块示例

#### 5.1.1 普攻特效示例

**魔剑士 - 普攻吸魔**
<战斗触发:Attack, a.gainMp(10)> //普攻时触发，为攻击者恢复10点MP

**狂战士 - 鲜血渴望**
<战斗触发:Attack, a.gainHp(-50); a.gainTp(10)> //普攻时触发，扣除攻击者50点HP，恢复10点TP

**赌徒 - 幸运一击**
<战斗触发:Attack, if(Math.random()<0.2) b.addState(5)> //普攻时触发，20%概率为目标添加状态5

**盗贼 - 偷钱**
<战斗触发:Attack, $gameParty.gainGold(Math.floor(Math.random()*10)+1)> //普攻时触发，获得1~10金币

#### 5.1.2 受击特效示例

**战士 - 坚韧**
<战斗触发:Hit, a.gainTp(5)> //受击时触发，为受击者恢复5点TP

**重甲卫士 - 应激防御**
<战斗触发:Hit, a.addState(30)> //受击时触发，为受击者添加状态30

**荆棘怪 - 反伤甲**
<战斗触发:Hit, b.gainHp(-dmg * 0.3); b.startDamagePopup()> //受击时触发，对攻击者造成30%真实伤害

**幻术师 - 闪避本能**
<战斗触发:Hit, if(dmg > 500) a.addState(40)> //受击时触发，如果伤害大于500，为受击者添加状态40

#### 5.1.3 亡语机制示例

**自爆怪 - 烈焰殉爆**
<战斗触发:Dead, b.gainHp(-1000); b.startDamagePopup()> //死亡时触发，对造成最后一击的敌人造成1000点伤害

**剧毒史莱姆 - 临死喷溅**
<战斗触发:Dead, b.addState(10)> //死亡时触发，为造成最后一击的敌人添加状态10

**圣职者 - 神圣遗志**
<战斗触发:Dead, $gameParty.deadMembers().forEach(m => { m.revive(); m.gainHp(9999); })> //死亡时触发，复活所有队友并恢复满HP

**赏金首领 - 巨额赏金**
<战斗触发:Dead, $gameParty.gainGold(5000)> //死亡时触发，获得5000金币


### 5.2 技能主动模块示例

#### 5.2.1 溅射伤害示例

**横扫 - 顺劈斩**
<溅射伤害: 0.5, 1> //对主目标左右各1个单位造成50%溅射伤害

**冲击波 - 直线贯通**
<溅射伤害: 0.8, 2> //对主目标左右各2个单位造成80%溅射伤害

**微风 - 轻微波及**
<溅射伤害: 0.1, 1> //对主目标左右各1个单位造成10%溅射伤害

#### 5.2.2 斩杀追击示例

**刺客 - 处决**
<斩杀追击: 30, 2000> //若目标血量低于30%，追加2000点真实伤害

**死神 - 灵魂收割**
<斩杀追击: 10, b.hp> //若目标血量低于10%，直接造成等于目标当前血量的伤害

**猎人 - 弱点补刀**
<斩杀追击: 50, a.atk * 2> //若目标血量低于50%，追加2倍攻击力的伤害

#### 5.2.3 技能吸血示例

**吸血鬼 - 吸血之触**
<技能吸血: 0.3> //回复伤害值30%的血量

**黑暗骑士 - 生命吞噬**
<技能吸血: 1.0> //造成多少伤害就回多少血(100%吸血)

**圣骑士 - 微量回覆**
<技能吸血: 0.05> //带有少量吸血效果(5%)的神圣打击

#### 5.2.4 状态交互示例

**法师 - 冰火引爆**
<状态交互: 15, a.mat * 3, true, Target> //若目标有状态15，造成3倍魔攻伤害并移除状态

**牧师 - 净化术**
<状态交互: 10, -500, true, AllAllies> //若队友有状态10，移除它并回复500血

**恶魔 - 吞噬力量**
<状态交互: 20, -1000, true, Self> //若自己有状态20，移除它并回复1000血

**死灵 - 疫病加重**
<状态交互: 30, 500, false, Target> //若目标有状态30，造成500伤害但不移除状态

#### 5.2.5 力场共鸣示例

**术士 - 连环尸爆**
<力场共鸣: 50, Spread, a.mat * 2, true> //引爆全场带有状态50的单位，造成魔攻2倍伤害并移除状态

**贤者 - 光之聚合**
<力场共鸣: 60, Gather, n * 2000, true> //统计全场带有状态60的人数n，对目标造成n*2000伤害

**辅助 - 共鸣治疗**
<力场共鸣: 70, Spread, -1000, false> //让全场带有状态70的单位回复1000血

### 5.3 高级机制模块示例

#### 5.3.1 伤害转移示例

**守护骑士 - 完全援护**
<伤害转移: 100, 100, d * 0.5, d> //队友受到的伤害100%被拦截，骑士只受50%伤害，队友完全不扣血

**灵魂锁链 - 痛苦分担**
<伤害转移: 101, 50> //队友受到的伤害，50%转移给施法者，两人各承受一半

**狂信徒 - 牺牲祝福**
<伤害转移: 102, 100, d, d * 1.5> //队友受伤时，狂信徒承受100%伤害，队友反而回复伤害值1.5倍的血量

#### 5.3.2 累计反击示例

**盾卫 - 盾牌反击**
<累计反击: 110, def, 200, d * 3> //开启姿态时防御力+200，再次释放造成累计伤害3倍的反击伤害

**剑圣 - 冥想蓄力**
<累计反击: 111, atk, 50, a.atk * 10> //开启姿态时攻击力+50，再次释放造成10倍攻击力的拔刀斩伤害

**武僧 - 忍耐**
<累计反击: 112, hp, 1000, d * 5> //开启姿态时血上限+1000，再次释放造成累计伤害5倍的真实伤害

#### 5.3.3 弹射伤害示例

**雷电法师 - 闪电链**
<弹射伤害: 3000, damage * 0.8, 3, 0, false, Random> //首发3000伤害，弹射3次，每次伤害衰减20%，随机目标

**猎手 - 回旋镖**
<弹射伤害: a.atk*2, damage, 4, 0, false, Order> //首发物攻2倍，弹射4次，伤害不衰减，按敌人站位顺序依次打击

**混沌法师 - 混乱法球**
<弹射伤害: 500, damage + 500, 5, 0, true, Random> //首发500伤害，弹射5次，每次伤害增加500，允许重复打同一个人

### 5.4 全局行动监听模块示例

#### 5.4.1 队友协战示例

**骑士 - 掩护攻击**
<队友协战: Attack, 30, 10> //当队友进行普攻时，30%概率使用技能10进行协战

**法师 - 元素共鸣**
<队友协战: Skill, 20, 15> //当队友使用技能时，20%概率使用技能15进行协战

**牧师 - 神圣守护**
<队友协战: Support, 50, 20> //当队友使用支援技能时，50%概率使用技能20进行协战

#### 5.4.2 敌方识破示例

**刺客 - 反制**
<敌方识破: Support, 100, 30> //当敌人使用支援技能时，100%概率使用技能30进行识破

**战士 - 拦截**
<敌方识破: Attack, 40, 35> //当敌人进行攻击时，40%概率使用技能35进行拦截

**巫师 - 混乱**
<敌方识破: Any, 15, 40> //当敌人进行任何行动时，15%概率使用技能40造成混乱

### 5.5 装备赋予能力的特殊案例 (New)

#### 5.5.1 传说武器：吸血鬼之触 (武器备注)
*效果：装备这把剑时，普通攻击会恢复自身 10 点 MP。*
<战斗触发: Attack, a.gainMp(10)>

#### 5.5.2 史诗防具：荆棘板甲 (防具备注)
*效果：穿戴这件铠甲时，受到伤害会反弹给攻击者 200 点真实伤害。*
<战斗触发: Hit, b.gainHp(-200); b.startDamagePopup(); b.performDamage()>

#### 5.5.3 饰品：指挥官指环 (防具备注)
*效果：佩戴此戒指时，当队友进行普通攻击，你有 50% 概率使用技能 15 (援护射击) 进行协战。*
<队友协战: Attack, 50, 15>

#### 5.5.4 诅咒装备：亡者护符 (防具备注)
*效果：佩戴者死亡时，会对凶手造成 9999 点复仇伤害。*
<战斗触发: Dead, b.gainHp(-9999)>

## 6. 常见问题

### 6.1 插件不生效
- 检查插件是否正确安装
- 检查插件优先级是否正确
- 检查备注栏格式是否正确
- 检查公式语法是否正确

### 6.2 公式执行错误
- 检查变量名是否正确
- 检查语法是否符合 JavaScript 规范
- 检查是否使用了不存在的方法或属性

### 6.3 伤害计算异常
- 检查公式中的数值是否合理
- 检查状态ID是否正确
- 检查范围参数是否正确

### 6.4 性能问题
- 避免在公式中使用过于复杂的逻辑
- 避免在频繁触发的事件中使用复杂计算
- 合理设置弹射次数和范围

## 7. 更新日志

### v2.9.6 (Current)
* **[Feature] 装备标签支持**：被动触发模块 (A) 和全局行动监听模块 (D) 现在支持读取武器和防具的备注。穿戴特定装备即可获得亡语、溅射、协战或识破能力。
* **[Core] 备注合并逻辑**：重写了标签读取核心，现在会自动将「角色本人 + 职业 + 所有装备」的备注内容合并处理。

### v2.9.4
* **[Fix] 敌方识破修复**：修复了 `<敌方识破>` 触发后无法强制插队执行的问题；修复了防御指令会错误触发攻击/辅助类识破的 Bug。
* **[AI] 智能目标锁定**：优化了协战和识破的目标选择逻辑。攻击类技能会自动锁定触发源（复仇），辅助类技能会自动锁定友方。

### v2.9.3
* **[Fix] 协战逻辑修正**：修复了玩家进行「防御」操作时，错误触发 `<队友协战: Attack>` 的问题（现已显式排除防御指令）。
* **[Fix] 强制执行**：为协战增加了 `forceAction` 强制执行权，确保队友能立刻跟进攻击。

### v2.9.2
* **[Feature] 溅射公式化**：`<溅射伤害>` 标签现在支持复杂的伤害公式（如 `a.atk * 0.8`）或固定数值，不再局限于简单的百分比。
* **[Fix] 视觉反馈修复**：彻底修复了溅射、吸血、反伤等机制只扣血不弹伤害数字（Pop-up）的问题，现在会有正常的受击动作和数字显示。
* **[Dev] 调试增强**：按 F8 可在控制台看到详细的溅射判定与伤害计算日志。

### v2.9.0 ~ v2.9.1
* **[Refactor] 正则引擎重构**：全面支持中文标点（：，）和英文标点混用，支持标签内包含空格，极大提高了容错率。
* **[Fix] 亡语判定修复**：修复了 `<战斗触发: Dead>` 在非致死攻击下触发或对尸体重复触发（鞭尸）的 Bug。
* **[Fix] 亡语打击感**：修复了亡语反击凶手时，凶手没有受伤动作和死亡动画的问题。

### v2.9.0
- 修复了溅射伤害因标点/空格问题无法触发的Bug
- 所有标签均支持中文标点(：，)和英文标点(:, )
- 补全了v2.6版本缺失的“协战/识破”监听模块
- 增强了正则表达式匹配，支持标签中的空格
- 优化了溅射伤害的目标筛选条件

### v2.6.0
- 重构了代码结构
- 优化了性能
- 修复了已知问题
- 增加了新的功能示例

### v2.5.0
- 增加了力场共鸣机制
- 优化了状态交互功能
- 修复了一些bug

### v2.0.0
- 初始版本
- 实现了基本的战斗机制

## 8. 联系方式

如有问题或建议，欢迎联系项目开发者：
- 作者：Secmon
- 重构：Gemini
- 邮箱：[595861835@qq.com]
- GitHub：[[项目地址](https://github.com/secmon0201/RanbowCastle_remake)]

---

**文档更新时间**: 2025-11-29
**文档版本**: 1.0.0
