# Sec_BattleSystemInstance.js 使用说明文档

## 1. 插件简介

### 1.1 基本信息
- **插件名称**: 战斗系统实例插件 - 终极案例库版
- **目标引擎**: RPG Maker MZ
- **当前版本**: 2.6.0
- **作者**: Secmon (Refactored by Gemini)
- **功能**: 允许在职业、敌人或技能的备注栏中填写特定标签，实现丰富的战斗机制

### 1.2 插件特点
- 模块化设计，功能清晰
- 支持多种战斗机制
- 提供丰富的实战案例
- 易于扩展和自定义

## 2. 安装说明

### 2.1 安装步骤
1. 将 `Sec_BattleSystemInstance.js` 文件放入项目的 `js/plugins/Sec/` 目录中
2. 在 RPG Maker MZ 编辑器中打开插件管理界面
3. 点击「插件管理」按钮
4. 点击「添加」按钮，选择该插件
5. 调整插件优先级（建议放在其他战斗相关插件之后）
6. 点击「确定」保存设置

### 2.2 配置要求
- RPG Maker MZ 1.9.1 或更高版本
- 支持 JavaScript 语法

## 3. 通用变量表

在所有公式中，您可以使用以下变量：

| 变量名 | 说明 |
|--------|------|
| `a`    | 动作使用者 (或 亡语中的死者 / 转移中的守护者) |
| `b`    | 动作目标   (或 亡语中的凶手 / 转移中的被守护者) |
| `v[n]` | 游戏变量（例如 `v[10]` 表示第10个变量） |
| `s[n]` | 游戏开关（例如 `s[5]` 表示第5个开关） |
| `dmg`  | 本次行动造成的实际伤害数值（仅受击/吸血等逻辑可用） |
| `d`    | 原始伤害值（仅在特定机制中可用） |
| `n`    | 队友数量或弹射次数（仅在特定机制中可用） |
| `damage` | 上一次造成的伤害值（仅在弹射伤害中可用） |

## 4. 功能模块说明

### 4.1 被动触发模块

#### 4.1.1 普攻特效

**填写位置**: 数据库 -> 职业 (Classes) -> 备注

**格式**: `<战斗触发:Attack, 公式>`

**参数说明**:
- `Attack`: 发起普攻时触发（仅对角色有效）
- `公式`: 任意有效的 JavaScript 代码

**示例**:
```
<战斗触发:Attack, a.gainMp(10)>
```

#### 4.1.2 受击特效

**填写位置**: 数据库 -> 职业 (Classes) -> 备注

**格式**: `<战斗触发:Hit, 公式>`

**参数说明**:
- `Hit`: 受到伤害时触发（仅对角色有效）
- `公式`: 任意有效的 JavaScript 代码

**示例**:
```
<战斗触发:Hit, a.gainTp(5)>
```

#### 4.1.3 亡语机制

**填写位置**: 数据库 -> 敌人 (Enemies) -> 备注

**格式**: `<战斗触发:Dead, 公式>`

**参数说明**:
- `Dead`: 角色死亡时触发
- `公式`: 任意有效的 JavaScript 代码
- `a`: 代表死者
- `b`: 代表造成最后一击的凶手

**示例**:
```
<战斗触发:Dead, b.gainHp(-1000); b.startDamagePopup()>
```

### 4.2 技能主动模块

#### 4.2.1 溅射伤害

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<溅射伤害: 比例, 范围>`

**参数说明**:
- `比例`: 0.0-1.0 之间的小数，代表溅射伤害的比例
- `范围`: 整数，代表溅射伤害的范围（主目标左右各几个单位）

**示例**:
```
<溅射伤害: 0.5, 1>
```

#### 4.2.2 斩杀追击

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<斩杀追击: 阈值%, 公式>`

**参数说明**:
- `阈值%`: 1-100 之间的整数，代表目标血量的百分比
- `公式`: 任意有效的 JavaScript 代码，代表斩杀追击时的伤害值

**示例**:
```
<斩杀追击: 30, 2000>
```

#### 4.2.3 技能吸血

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<技能吸血: 比例>`

**参数说明**:
- `比例`: 0.0-1.0 之间的小数，代表技能吸血的比例

**示例**:
```
<技能吸血: 0.3>
```

#### 4.2.4 状态交互

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<状态交互: 状态ID, 公式, 移除?, 范围>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `公式`: 任意有效的 JavaScript 代码，正数伤，负数奶
- `移除?`: `true` 或 `false`，代表是否移除状态
- `范围`: `Target`（仅对目标生效）、`Self`（仅对自己生效）、`AllAllies`（对所有队友生效）

**示例**:
```
<状态交互: 15, a.mat * 3, true, Target>
```

#### 4.2.5 力场共鸣

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<力场共鸣: 状态ID, 模式, 公式, 移除?>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `模式`: `Spread`（炸全场）、`Gather`（聚合并炸单体）
- `公式`: 任意有效的 JavaScript 代码，正数伤，负数奶
- `移除?`: `true` 或 `false`，代表是否移除状态

**示例**:
```
<力场共鸣: 50, Spread, a.mat * 2, true>
```

### 4.3 高级机制模块

#### 4.3.1 伤害转移

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<伤害转移: 状态ID, 分摊比例%, 转移公式, 恢复公式>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `分摊比例%`: 0.0-100.0 之间的小数，代表伤害转移的比例
- `转移公式`: 任意有效的 JavaScript 代码，代表伤害转移时的伤害值
- `恢复公式`: 任意有效的 JavaScript 代码，代表被守护者要回多少血

**示例**:
```
<伤害转移: 100, 100, d * 0.5, d>
```

#### 4.3.2 累计反击

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<累计反击: 状态ID, 属性, 值, 反击公式>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `属性`: 开启期间提升的属性，如 "def"、"atk"、"mat" 等
- `值`: 属性提升的数值
- `反击公式`: 释放时的伤害公式

**示例**:
```
<累计反击: 110, def, 200, d * 3>
```

#### 4.3.3 弹射伤害

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<弹射伤害: 初始公式, 弹射公式, 次数, 倍率上限, 允许重复?, 模式>`

**参数说明**:
- `初始公式`: 对第一个目标的伤害
- `弹射公式`: 对后续目标的伤害
- `次数`: 额外弹射几次
- `倍率上限`: 0 表示无限制，>0 表示公式中的 n 最大只能取到这个值
- `允许重复?`: `true` 或 `false`，代表是否可以打同一个人
- `模式`: `Random`（随机选择下一个）、`Order`（按敌人站位顺序）

**示例**:
```
<弹射伤害: 3000, damage * 0.8, 3, 0, false, Random>
```

## 5. 使用示例

### 5.1 被动触发模块示例

#### 5.1.1 普攻特效示例

**魔剑士 - 普攻吸魔**
```
<战斗触发:Attack, a.gainMp(10)>
```

**狂战士 - 鲜血渴望**
```
<战斗触发:Attack, a.gainHp(-50); a.gainTp(10)>
```

**赌徒 - 幸运一击**
```
<战斗触发:Attack, if(Math.random()<0.2) b.addState(5)>
```

**盗贼 - 偷钱**
```
<战斗触发:Attack, $gameParty.gainGold(Math.floor(Math.random()*10)+1)>
```

#### 5.1.2 受击特效示例

**战士 - 坚韧**
```
<战斗触发:Hit, a.gainTp(5)>
```

**重甲卫士 - 应激防御**
```
<战斗触发:Hit, a.addState(30)>
```

**荆棘怪 - 反伤甲**
```
<战斗触发:Hit, b.gainHp(-dmg * 0.3); b.startDamagePopup()>
```

**幻术师 - 闪避本能**
```
<战斗触发:Hit, if(dmg > 500) a.addState(40)>
```

#### 5.1.3 亡语机制示例

**自爆怪 - 烈焰殉爆**
```
<战斗触发:Dead, b.gainHp(-1000); b.startDamagePopup()>
```

**剧毒史莱姆 - 临死喷溅**
```
<战斗触发:Dead, b.addState(10)>
```

**圣职者 - 神圣遗志**
```
<战斗触发:Dead, $gameParty.deadMembers().forEach(m => { m.revive(); m.gainHp(9999); })>
```

**赏金首领 - 巨额赏金**
```
<战斗触发:Dead, $gameParty.gainGold(5000)>
```

### 5.2 技能主动模块示例

#### 5.2.1 溅射伤害示例

**横扫 - 顺劈斩**
```
<溅射伤害: 0.5, 1>
```

**冲击波 - 直线贯通**
```
<溅射伤害: 0.8, 2>
```

**微风 - 轻微波及**
```
<溅射伤害: 0.1, 1>
```

#### 5.2.2 斩杀追击示例

**刺客 - 处决**
```
<斩杀追击: 30, 2000>
```

**死神 - 灵魂收割**
```
<斩杀追击: 10, b.hp>
```

**猎人 - 弱点补刀**
```
<斩杀追击: 50, a.atk * 2>
```

#### 5.2.3 技能吸血示例

**吸血鬼 - 吸血之触**
```
<技能吸血: 0.3>
```

**黑暗骑士 - 生命吞噬**
```
<技能吸血: 1.0>
```

**圣骑士 - 微量回覆**
```
<技能吸血: 0.05>
```

#### 5.2.4 状态交互示例

**法师 - 冰火引爆**
```
<状态交互: 15, a.mat * 3, true, Target>
```

**牧师 - 净化术**
```
<状态交互: 10, -500, true, AllAllies>
```

**恶魔 - 吞噬力量**
```
<状态交互: 20, -1000, true, Self>
```

**死灵 - 疫病加重**
```
<状态交互: 30, 500, false, Target>
```

#### 5.2.5 力场共鸣示例

**术士 - 连环尸爆**
```
<力场共鸣: 50, Spread, a.mat * 2, true>
```

**贤者 - 光之聚合**
```
<力场共鸣: 60, Gather, n * 2000, true>
```

**辅助 - 共鸣治疗**
```
<力场共鸣: 70, Spread, -1000, false>
```

### 5.3 高级机制模块示例

#### 5.3.1 伤害转移示例

**守护骑士 - 完全援护**
```
<伤害转移: 100, 100, d * 0.5, d>
```

**灵魂锁链 - 痛苦分担**
```
<伤害转移: 101, 50>
```

**狂信徒 - 牺牲祝福**
```
<伤害转移: 102, 100, d, d * 1.5>
```

#### 5.3.2 累计反击示例

**盾卫 - 盾牌反击**
```
<累计反击: 110, def, 200, d * 3>
```

**剑圣 - 冥想蓄力**
```
<累计反击: 111, atk, 50, a.atk * 10>
```

**武僧 - 忍耐**
```
<累计反击: 112, hp, 1000, d * 5>
```

#### 5.3.3 弹射伤害示例

**雷电法师 - 闪电链**
```
<弹射伤害: 3000, damage * 0.8, 3, 0, false, Random>
```

**猎手 - 回旋镖**
```
<弹射伤害: a.atk*2, damage, 4, 0, false, Order>
```

**混沌法师 - 混乱法球**
```
<弹射伤害: 500, damage + 500, 5, 0, true, Random>
```

## 6. 常见问题

### 6.1 插件不生效
- 检查插件是否正确安装
- 检查插件优先级是否正确
- 检查备注栏格式是否正确
- 检查公式语法是否正确

### 6.2 公式执行错误
- 检查变量名是否正确
- 检查语法是否符合 JavaScript 规范
- 检查是否使用了不存在的方法或属性

### 6.3 伤害计算异常
- 检查公式中的数值是否合理
- 检查状态ID是否正确
- 检查范围参数是否正确

### 6.4 性能问题
- 避免在公式中使用过于复杂的逻辑
- 避免在频繁触发的事件中使用复杂计算
- 合理设置弹射次数和范围

## 7. 更新日志

### v2.6.0
- 重构了代码结构
- 优化了性能
- 修复了已知问题
- 增加了新的功能示例

### v2.5.0
- 增加了力场共鸣机制
- 优化了状态交互功能
- 修复了一些bug

### v2.0.0
- 初始版本
- 实现了基本的战斗机制

## 8. 联系方式

如有问题或建议，欢迎联系项目开发者：
- 作者：Secmon
- 重构：Gemini
- 邮箱：[开发者邮箱]
- GitHub：[项目地址]

---

**文档更新时间**: 2025-11-29
**文档版本**: 1.0.0
