# Sec_BattleSystemInstance.js 使用说明文档

## 1. 插件简介

### 1.1 基本信息
- **插件名称**: 战斗系统实例插件 - 日志净化终极版
- **目标引擎**: RPG Maker MZ
- **当前版本**: 3.5.3
- **作者**: Secmon (Refactored by Gemini)
- **功能**: 允许在角色、职业、装备、敌人或技能的备注栏中填写特定标签，实现丰富的战斗机制，并具备日志净化功能

### 1.2 插件特点
- **日志净化终极版**：彻底屏蔽所有被动触发产生的战斗文字日志，保留视觉反馈
- **全参数化调整**：所有延迟时间均可在插件参数中调整
- **新增蓄力系统**：受击蓄力和蓄力释放机制
- **新增守护光环**：伤害转移和守护机制
- **增强弹射伤害**：支持递减延迟的闪电链效果，第一跳使用初始公式，后续跳使用递推公式
- **全面支持装备标签**：穿戴特定武器/防具即可获得被动或协战能力
- **模块化设计**：功能清晰，易于扩展和自定义
- **支持中文标点和英文标点**：提高了容错率
- **支持标签中的空格**：增强了正则表达式匹配

## 2. 安装说明

### 2.1 安装步骤
1. 将 `Sec_BattleSystemInstance.js` 文件放入项目的 `js/plugins/Sec/` 目录中
2. 在 RPG Maker MZ 编辑器中打开插件管理界面
3. 点击「插件管理」按钮
4. 点击「添加」按钮，选择该插件
5. 调整插件优先级（建议放在其他战斗相关插件之后）
6. 点击「确定」保存设置

### 2.2 配置要求
- RPG Maker MZ 1.9.1 或更高版本
- 支持 JavaScript 语法

### 2.3 插件参数设置

插件提供了以下可调整的参数，用于优化战斗体验：

| 参数名称 | 描述 | 默认值 | 建议范围 |
|----------|------|--------|----------|
| `DefAnimHit` | 默认打击动画ID | 1 | 任意有效动画ID |
| `DefAnimHeal` | 默认治疗动画ID | 46 | 任意有效动画ID |
| `DefAnimBuff` | 默认Buff动画ID | 52 | 任意有效动画ID |
| `GuardianDelay` | 守护光环间隔(ms) | 200 | 150-300 |
| `ChargeDelay` | 蓄力释放延迟(ms) | 400 | 300-500 |
| `SynergyDelay` | 队友协战延迟(ms) | 200 | 100-300 |
| `StateInteractDelay` | 状态交互延迟(ms) | 200 | 150-300 |
| `FieldResonanceDelay` | 力场共鸣延迟(ms) | 200 | 200-300 |
| `RicochetBaseDelay` | 闪电链初始间隔(ms) | 200 | 150-300 |
| `RicochetDecay` | 闪电链延迟递减(ms) | 30 | 10-50 |

## 3. 通用变量表

在所有公式中，您可以使用以下变量：

| 变量名 | 说明 |
|--------|------|
| `a`    | 动作使用者 (或 亡语中的死者 / 转移中的守护者) |
| `b`    | 动作目标   (或 亡语中的凶手 / 转移中的被守护者) |
| `v[n]` | 游戏变量（例如 `v[10]` 表示第10个变量） |
| `d`    | 原始伤害值（仅在特定机制中可用） |
| `dmg`  | 本次行动造成的实际伤害数值（仅受击/吸血等逻辑可用） |
| `damage` | 上一次造成的伤害值（仅在弹射伤害中可用） |
| `n`    | 队友数量或弹射次数（仅在特定机制中可用） |

## 4. 日志净化功能

### 4.1 什么是日志净化
日志净化是指屏蔽被动触发（如攻击特效、受击特效、亡语等）产生的战斗文字日志，同时保留伤害数字、回血数字、受击动画等视觉反馈。

### 4.2 支持日志净化的模块
- 攻击特效（<战斗触发:Attack, 公式>）
- 受击特效（<战斗触发:Hit, 公式>）
- 亡语机制（<战斗触发:Dead, 公式>）
- 状态交互（<状态交互: 状态ID, 公式, 移除?, 范围>）
- 溅射伤害（<溅射伤害: 公式, 范围>）
- 技能吸血（<技能吸血: 比例>）
- 蓄力释放（<蓄力释放: 状态ID, 公式>）
- 守护光环（<守护光环: 状态ID, 比例, 公式>）
- 力场共鸣（<力场共鸣: 状态ID, 模式, 公式, 移除?>）
- 弹射伤害（<弹射伤害: 初始公式, 递推公式, 次数, 上限, 重复?, 模式>）

### 4.3 日志净化的实现方式
系统通过给角色打上静音标记（_ignoreDamageLog 和 _ignoreMpLog）来实现日志净化。这些标记会在每个新动作开始前自动清除，确保只屏蔽当前动作产生的日志。

### 4.4 日志净化的效果
- 屏蔽战斗文字日志，避免信息刷屏
- 保留所有视觉反馈，不影响游戏体验
- 解决了"受击回蓝"等标签导致战斗信息过多的问题

## 5. 功能模块说明

### 5.1 模块 A：被动触发 (Passives)

**位置**：
- 角色 (Actor) 备注
- 职业 (Class) 备注
- 武器/防具 (Weapon/Armor) 备注
- 敌人 (Enemy) 备注
- 状态 (State) 备注

*说明：系统会自动读取角色身上所有的备注信息（职业+装备+本体+状态），只要其中一处有标签即可生效。*

#### 5.1.1 普攻特效

**填写位置**: 角色/职业/装备/敌人/状态 备注

**格式**: `<战斗触发:Attack, 公式>`

**参数说明**:
- `Attack`: 发起普攻时触发
- `公式`: 任意有效的 JavaScript 代码

**示例**:
<战斗触发:Attack, a.gainMp(10)> //普攻时触发，为攻击者恢复10点MP

#### 5.1.2 受击特效

**填写位置**: 角色/职业/装备/敌人/状态 备注

**格式**: `<战斗触发:Hit, 公式>`

**参数说明**:
- `Hit`: 受到伤害时触发
- `公式`: 任意有效的 JavaScript 代码

**示例**:
<战斗触发:Hit, a.gainTp(5)> //受击时触发，为受击者恢复5点TP

#### 5.1.3 亡语机制

**填写位置**: 角色/职业/装备/敌人/状态 备注

**格式**: `<战斗触发:Dead, 公式>`

**参数说明**:
- `Dead`: 角色死亡时触发
- `公式`: 任意有效的 JavaScript 代码
- `a`: 代表死者
- `b`: 代表造成最后一击的凶手

**示例**:
<战斗触发:Dead, b.gainHp(-1000); b.startDamagePopup()> //死亡时触发，对造成最后一击的敌人造成1000点伤害

#### 5.1.4 受击蓄力

**填写位置**: 角色/职业/装备/状态 备注

**格式**: `<受击蓄力: 状态ID>`

**参数说明**:
- `状态ID`: 整数，代表蓄力状态的ID

**功能说明**:
当持有此状态ID时，受到的伤害会被记录下来，用于后续的蓄力释放。

**示例**:
<受击蓄力: 50> //当受到伤害时，如果有状态50，累计伤害值

#### 5.1.5 蓄力释放

**填写位置**: 角色/职业/装备/状态 备注

**格式**: `<蓄力释放: 状态ID, 公式, 动画ID>`

**参数说明**:
- `状态ID`: 整数，代表蓄力状态的ID
- `公式`: 任意有效的 JavaScript 代码
  - 变量 `d` = 累计的伤害值
  - 变量 `a` = 自身
  - 变量 `b` = 敌人
- `动画ID`: 可选，默认使用插件参数中设置的打击动画

**功能说明**:
攻击时，如果持有此状态且有蓄力值，则触发额外伤害，动画播放于敌人身上。

**示例**:
<蓄力释放: 50, d * 2, 1> //释放双倍累计伤害，使用动画ID 1

#### 5.1.6 守护光环

**填写位置**: 角色/职业/装备/状态 备注

**格式**: `<守护光环: 状态ID, 承伤比例, 公式, 动画ID>`

**参数说明**:
- `状态ID`: 整数，代表守护状态的ID
- `承伤比例`: 0.0-1.0 之间的小数，代表转移伤害的比例
- `公式`: 任意有效的 JavaScript 代码，用于计算守护者实际承受的伤害
  - 变量 `damage` = 原伤害
- `动画ID`: 可选，默认使用插件参数中设置的Buff动画

**功能说明**:
当队友受伤时，如果持有此状态且活着，则分担伤害，动画播放于被守护的队友身上。

**示例**:
<守护光环: 60, 0.8, damage * 0.8, 52> //坦克必须有60号状态。队友受伤时，80%的伤害转移给坦克，坦克实际承受转移量的80%，使用动画ID 52

### 5.2 模块 B：技能特效 (Skill Actives)

**位置**：
- 数据库 -> 技能 (Skills) -> 备注

#### 5.2.1 状态交互

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<状态交互: 状态ID, 公式, 移除?, 范围, 动画ID>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `公式`: 任意有效的 JavaScript 代码，正数伤，负数奶
- `移除?`: `true` 或 `false`，代表是否移除状态
- `范围`: `Target`（仅对目标生效）、`Self`（仅对自己生效）、`AllAllies`（对所有队友生效）
- `动画ID`: 可选，默认自适应（Target=1, AllAllies=46, Self=52）

**示例**:
<状态交互: 15, a.mat * 3, true, Target, 1> //若目标有状态15，造成3倍魔攻伤害并移除状态，使用动画ID 1

#### 5.2.2 力场共鸣

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<力场共鸣: 状态ID, 模式, 公式, 移除?, 动画ID>`

**参数说明**:
- `状态ID`: 整数，代表目标或队友的状态ID
- `模式`: `Spread`（炸全场）、`Gather`（聚合并炸单体）
- `公式`: 任意有效的 JavaScript 代码，正数伤，负数奶
- `移除?`: `true` 或 `false`，代表是否移除状态
- `动画ID`: 可选，默认使用插件参数中设置的打击动画

**示例**:
<力场共鸣: 50, Spread, a.mat * 2, true, 1> //引爆全场带有状态50的单位，造成魔攻2倍伤害并移除状态，使用动画ID 1

#### 5.2.3 溅射伤害

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<溅射伤害: 公式, 范围, 动画ID>`

**参数说明**:
- `公式`: 可以是 0.0-1.0 之间的小数（代表溅射伤害的比例），也可以是 JavaScript 计算公式
- `范围`: 整数，代表溅射伤害的范围（主目标左右各几个单位）
- `动画ID`: 可选，默认使用插件参数中设置的打击动画

**示例**:
<溅射伤害: 0.5, 1, 1> //对主目标左右各1个单位造成50%溅射伤害，使用动画ID 1
<溅射伤害: (a.atk/1000), 2, 1> //对主目标左右各2个单位造成基于攻击力的溅射伤害，使用动画ID 1

#### 5.2.4 弹射伤害 (闪电链)

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<弹射伤害: 初始公式, 递推公式, 次数, 上限, 重复?, 模式, 动画ID>`

**参数说明**:
- `初始公式`: 对第一跳目标的伤害公式
- `递推公式`: 对后续弹跳目标的伤害公式
- `次数`: 整数，代表额外弹射次数
- `上限`: 整数，代表单次最大伤害（0为不限）
- `重复?`: `true` 或 `false`，代表是否允许弹回同一个人
- `模式`: `Random`（随机）、`Order`（按站位顺序）
- `动画ID`: 可选，默认使用插件参数中设置的打击动画

**功能特点**:
- **递减延迟**: 每次弹射的间隔时间逐渐减少，营造更快的连锁反应
- **智能目标选择**: 根据模式选择下一个目标
- **伤害上限**: 可设置单次最大伤害，防止伤害失控
- **修复版公式应用**: 第一跳使用初始公式，后续跳使用递推公式

**示例**:
<弹射伤害: 500, damage * 0.8, 3, 0, false, Random, 1> //首发500伤害，弹3次，第一跳500，后续每次衰减20%，不重复，随机目标，使用动画ID 1

#### 5.2.5 斩杀追击

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<斩杀追击: 阈值%, 公式, 动画ID>`

**参数说明**:
- `阈值%`: 0-100 之间的整数，代表目标血量的百分比
- `公式`: 任意有效的 JavaScript 代码，代表斩杀追击时的伤害值
- `动画ID`: 可选，默认使用插件参数中设置的打击动画

**示例**:
<斩杀追击: 30, 2000, 1> //若目标血量低于30%，追加2000点真实伤害，使用动画ID 1

#### 5.2.6 技能吸血

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<技能吸血: 比例, 动画ID>`

**参数说明**:
- `比例`: 0.0-1.0 之间的小数，代表技能吸血的比例
- `动画ID`: 可选，默认使用插件参数中设置的治疗动画

**示例**:
<技能吸血: 0.3, 46> //回复伤害值30%的血量，使用动画ID 46

#### 5.2.7 状态循环

**填写位置**: 数据库 -> 技能 (Skills) -> 备注

**格式**: `<状态循环: 状态ID列表>`

**参数说明**:
- `状态ID列表`: 多个状态ID，用逗号分隔

**功能说明**:
按顺序循环切换状态，无动画参数。

**示例**:
<状态循环: 10, 11, 12> //按顺序循环切换状态10、11、12

### 5.3 模块 C：全局行动监听

**位置**：
- 角色 (Actor) 备注
- 职业 (Class) 备注
- 武器/防具 (Weapon/Armor) 备注
- 敌人 (Enemy) 备注

#### 5.3.1 队友协战

**填写位置**: 角色/职业/装备/敌人 备注

**格式**: `<队友协战: 触发类型, 概率%, 技能ID>`

**参数说明**:
- `触发类型`: `Attack`（普攻）、`Skill`（技能）、`Support`（支援）、`Any`（任意）
  - 除 `Any` 类型外，其他类型均不包含防御动作
- `概率%`: 0-100 之间的整数，代表触发协战的概率
- `技能ID`: 整数，代表协战时使用的技能ID

**功能特点**:
- **参数化延迟**: 使用 `SynergyDelay` 参数控制协战延迟，可在插件设置中调整
- **强制插队**: 使用 `forceAction` 确保协战执行
- **智能目标锁定**: 根据原行动的目标选择协战目标

**示例**:
<队友协战: Attack, 30, 10> //当队友进行普攻时，30%概率使用技能10进行协战

#### 5.3.2 敌方识破

**填写位置**: 角色/职业/装备/敌人 备注

**格式**: `<敌方识破: 触发类型, 概率%, 技能ID>`

**参数说明**:
- `触发类型`: `Support`（支援）、`Attack`（攻击）、`Any`（任意）
  - 排除防御：玩家防御不会误触发 Attack/Support 类型的识破
- `概率%`: 0-100 之间的整数，代表触发识破的概率
- `技能ID`: 整数，代表识破时使用的技能ID

**功能特点**:
- **强制插队**: 使用 `forceAction` 确保敌人立刻反击
- **目标智能锁定**:
  - 如果敌人反击用的是攻击技能，会精准锁定触发者（玩家）
  - 如果敌人反击用的是 Buff/回血技能，会锁定自己

**示例**:
<敌方识破: Support, 100, 30> //当敌人使用支援技能时，100%概率使用技能30进行识破

## 6. 使用示例

### 6.1 被动触发模块示例

#### 6.1.1 普攻特效示例

**魔剑士 - 普攻吸魔**
<战斗触发:Attack, a.gainMp(10)> //普攻时触发，为攻击者恢复10点MP

**狂战士 - 鲜血渴望**
<战斗触发:Attack, a.gainHp(-50); a.gainTp(10)> //普攻时触发，扣除攻击者50点HP，恢复10点TP

**赌徒 - 幸运一击**
<战斗触发:Attack, if(Math.random()<0.2) b.addState(5)> //普攻时触发，20%概率为目标添加状态5

#### 6.1.2 受击特效示例

**战士 - 坚韧**
<战斗触发:Hit, a.gainTp(5)> //受击时触发，为受击者恢复5点TP

**重甲卫士 - 应激防御**
<战斗触发:Hit, a.addState(30)> //受击时触发，为受击者添加状态30

**荆棘怪 - 反伤甲**
<战斗触发:Hit, b.gainHp(-dmg * 0.3); b.startDamagePopup()> //受击时触发，对攻击者造成30%真实伤害

#### 6.1.3 受击蓄力与释放示例

**拳师 - 蓄力姿态**
<受击蓄力: 50> //当受到伤害时，如果有状态50，累计伤害值

**拳师 - 蓄力爆发**
<蓄力释放: 50, d * 2, 1> //释放双倍累计伤害，使用动画ID 1

#### 6.1.4 守护光环示例

**圣骑士 - 神圣守护**
<守护光环: 60, 0.8, damage * 0.8, 52> //队友受伤时，80%的伤害转移给圣骑士，圣骑士实际承受转移量的80%，使用动画ID 52

### 6.2 技能特效模块示例

#### 6.2.1 状态交互示例

**法师 - 冰火引爆**
<状态交互: 15, a.mat * 3, true, Target, 1> //若目标有状态15，造成3倍魔攻伤害并移除状态，使用动画ID 1

**牧师 - 净化术**
<状态交互: 10, -500, true, AllAllies, 46> //若队友有状态10，移除它并回复500血，使用动画ID 46

#### 6.2.2 力场共鸣示例

**术士 - 连环尸爆**
<力场共鸣: 50, Spread, a.mat * 2, true, 1> //引爆全场带有状态50的单位，造成魔攻2倍伤害并移除状态，使用动画ID 1

**贤者 - 光之聚合**
<力场共鸣: 60, Gather, n * 2000, true, 1> //统计全场带有状态60的人数n，对目标造成n*2000伤害，使用动画ID 1

#### 6.2.3 溅射伤害示例

**横扫 - 顺劈斩**
<溅射伤害: 0.5, 1, 1> //对主目标左右各1个单位造成50%溅射伤害，使用动画ID 1

**冲击波 - 直线贯通**
<溅射伤害: 0.8, 2, 1> //对主目标左右各2个单位造成80%溅射伤害，使用动画ID 1

#### 6.2.4 弹射伤害示例

**雷电法师 - 闪电链**
<弹射伤害: 3000, damage * 0.8, 3, 0, false, Random, 1> //首发3000伤害，弹3次，第一跳500，后续每次衰减20%，不重复，随机目标，使用动画ID 1

**猎手 - 回旋镖**
<弹射伤害: a.atk*2, damage, 4, 0, false, Order, 1> //首发物攻2倍，弹射4次，伤害不衰减，按敌人站位顺序依次打击，使用动画ID 1

### 6.3 全局行动监听示例

#### 6.3.1 队友协战示例

**骑士 - 掩护攻击**
<队友协战: Attack, 30, 10> //当队友进行普攻时，30%概率使用技能10进行协战

**法师 - 元素共鸣**
<队友协战: Skill, 20, 15> //当队友使用技能时，20%概率使用技能15进行协战

#### 6.3.2 敌方识破示例

**刺客 - 反制**
<敌方识破: Support, 100, 30> //当敌人使用支援技能时，100%概率使用技能30进行识破

**战士 - 拦截**
<敌方识破: Attack, 40, 35> //当敌人进行攻击时，40%概率使用技能35进行拦截

### 6.4 装备赋予能力示例

#### 6.4.1 传说武器：吸血鬼之触 (武器备注)
*效果：装备这把剑时，普通攻击会恢复自身 10 点 MP。*
<战斗触发: Attack, a.gainMp(10)>

#### 6.4.2 史诗防具：荆棘板甲 (防具备注)
*效果：穿戴这件铠甲时，受到伤害会反弹给攻击者 200 点真实伤害。*
<战斗触发: Hit, b.gainHp(-200); b.startDamagePopup()>

#### 6.4.3 饰品：指挥官指环 (防具备注)
*效果：佩戴此戒指时，当队友进行普通攻击，你有 50% 概率使用技能 15 (援护射击) 进行协战。*
<队友协战: Attack, 50, 15>

## 7. 常见问题

### 7.1 插件不生效
- 检查插件是否正确安装
- 检查插件优先级是否正确
- 检查备注栏格式是否正确
- 检查公式语法是否正确

### 7.2 公式执行错误
- 检查变量名是否正确
- 检查语法是否符合 JavaScript 规范
- 检查是否使用了不存在的方法或属性

### 7.3 伤害计算异常
- 检查公式中的数值是否合理
- 检查状态ID是否正确
- 检查范围参数是否正确

### 7.4 性能问题
- 避免在公式中使用过于复杂的逻辑
- 避免在频繁触发的事件中使用复杂计算
- 合理设置弹射次数和范围

## 8. 更新日志

### v3.5.3 (Current)
* **[修复] 彻底修复了战斗消息屏蔽失效的问题**（移除了错误的恢复逻辑）
* **[调整] “受击蓄力”不再支持动画参数**
* **[调整] “守护光环”的动画现在正确播放于被守护的队友身上**

### v3.5.2
* **[修复] 修复了日志净化功能的一些边缘情况**
* **[优化] 调整了部分机制的默认动画设置**

### v3.5.1
* **[Feature] 全面支持动画参数**：所有机制都支持自定义动画ID
* **[优化] 日志净化功能增强**：支持更多模块的日志屏蔽

### v3.3.2
* **[核心修复] 彻底屏蔽了所有被动触发产生的战斗文字日志**
* **[视觉优化] 完美保留伤害数字、回血数字、受击动画等视觉反馈**
* **[解决问题] 解决了“受击回蓝”等标签导致战斗信息刷屏的问题**
* **[增强] 弹射伤害修复**：正确应用初始公式和递推公式
* **[优化] 协战延迟参数化**：使用 `SynergyDelay` 参数控制协战延迟

### v3.3.0
* **[Refactor] 全参数化调整**：所有延迟时间均可在插件参数中调整
* **[Feature] 增强弹射伤害**：支持递减延迟的闪电链效果
* **[Core] 守护光环响应速度优化**：守护光环的触发机制得到优化

### v3.0.0
* **[Refactor] 性能优化**：移除了老旧的 processComplexFeatures 和全局 Map
* **[Feature] 蓄力系统**：新增受击蓄力和蓄力释放机制
* **[Feature] 守护光环**：新增伤害转移和守护机制
* **[Core] 模块整合**：累计反击和伤害转移完全融入被动模块

---

**文档更新时间**: 2025-12-04
**文档版本**: 3.5.3